#cloud-config

write_files:
  # Postgres
  - path: /run/install-postgres.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: YXBrIGFkZCBwb3N0Z3Jlc3FsMTUgcG9zdGdyZXNxbDE1LWNvbnRyaWIgcG9zdGdyZXNxbDE1LW9wZW5yYwoKcmMtdXBkYXRlIGFkZCBwb3N0Z3Jlc3FsCgpyYy1zZXJ2aWNlIHBvc3RncmVzcWwgc3RhcnQ=

  # App
  - path: /run/install-app.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: YXBrIGFkZCBweXRob24zIHB5My1waXAKCm12IC90bXAvYXBwIC91c3IvbG9jYWwvYXBwCgpjZCAvdXNyL2xvY2FsL2FwcAoKIyByZW1vdmUgaG9zdCB2ZW52CnJtIC1yZiAudmVudgoKcHl0aG9uMyAtbSB2ZW52IC52ZW52Ci4gLnZlbnYvYmluL2FjdGl2YXRlCgpwaXAgaW5zdGFsbCAtciByZXF1aXJlbWVudHMudHh0CgpjYXQgPDwgRU9GID4gL2V0Yy9pbml0LmQvdG9kb2FwcAojIS9zYmluL29wZW5yYy1ydW4KbmFtZT0idG9kb2FwcCIKY29tbWFuZD0iL3Vzci9sb2NhbC9hcHAvLnZlbnYvYmluL3B5dGhvbiIKY29tbWFuZF9hcmdzPSIvdXNyL2xvY2FsL2FwcC9hcHAucHkiCmNvbW1hbmRfYmFja2dyb3VuZD0ieWVzIgpwaWRmaWxlPSIvcnVuL3RvZG9hcHAucGlkIgpvdXRwdXRfbG9nPSIvdmFyL2xvZy90b2RvYXBwLmxvZyIKZXJyb3JfbG9nPSIvdmFyL2xvZy90b2RvYXBwLmVyciIKRU9GCgpjaG1vZCAreCAvZXRjL2luaXQuZC90b2RvYXBwCgpyYy11cGRhdGUgYWRkIHRvZG9hcHAgZGVmYXVsdApyYy1zZXJ2aWNlIHRvZG9hcHAgc3RhcnQK

  - path: /tmp/app/app.py
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: aW1wb3J0IG9zCgpmcm9tIGZsYXNrIGltcG9ydCBGbGFzaywgcmVuZGVyX3RlbXBsYXRlLCByZXF1ZXN0LCByZWRpcmVjdCwgdXJsX2ZvcgppbXBvcnQgcHN5Y29wZzIKCmFwcCA9IEZsYXNrKF9fbmFtZV9fKQoKZGVmIGdldF9kYl9jb25uKCk6CiAgICByZXR1cm4gcHN5Y29wZzIuY29ubmVjdCgKICAgICAgICBob3N0PW9zLmVudmlyb24uZ2V0KCdEQl9IT1NUJykgb3IgJ2xvY2FsaG9zdCcsCiAgICAgICAgdXNlcj1vcy5lbnZpcm9uLmdldCgnREJfVVNFUicpIG9yICdwb3N0Z3JlcycsCiAgICAgICAgcGFzc3dvcmQ9b3MuZW52aXJvbi5nZXQoJ0RCX1BBU1NXT1JEJykgb3IgJ3Bhc3N3b3JkJywKICAgICAgICBkYXRhYmFzZT1vcy5lbnZpcm9uLmdldCgnREJfTkFNRScpIG9yICdwb3N0Z3JlcycsCiAgICApCgpjb25uID0gZ2V0X2RiX2Nvbm4oKQpjdXIgPSBjb25uLmN1cnNvcigpCmN1ci5leGVjdXRlKCIiIgogICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdGFza3MgKAogICAgICAgIGlkIFNFUklBTCBQUklNQVJZIEtFWSwKICAgICAgICB0aXRsZSBWQVJDSEFSIE5PVCBOVUxMLAogICAgICAgIGRvbmUgQk9PTEVBTiBOT1QgTlVMTCBERUZBVUxUIGZhbHNlCiAgICApOwoiIiIpCmNvbm4uY29tbWl0KCkKY3VyLmNsb3NlKCkKY29ubi5jbG9zZSgpCgpAYXBwLnJvdXRlKCcvJywgbWV0aG9kcz1bJ0dFVCddKQpkZWYgaW5kZXgoKToKICAgIGNvbm4gPSBnZXRfZGJfY29ubigpCiAgICBjdXIgPSBjb25uLmN1cnNvcigpCiAgICBjdXIuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSB0YXNrcyIpCiAgICB0YXNrcyA9IGN1ci5mZXRjaGFsbCgpCiAgICBjdXIuY2xvc2UoKQogICAgY29ubi5jbG9zZSgpCgogICAgcmV0dXJuIHJlbmRlcl90ZW1wbGF0ZSgnaW5kZXguaHRtbCcsIHRhc2tzPVt7J2lkJzogdGFza1swXSwgJ3RpdGxlJzogdGFza1sxXSwgJ2RvbmUnOiB0YXNrWzJdfSBmb3IgdGFzayBpbiB0YXNrc10pCgoKQGFwcC5yb3V0ZSgnL2FkZCcsIG1ldGhvZHM9WydQT1NUJ10pCmRlZiBhZGRfdGFzaygpOgogICAgdGl0bGUgPSByZXF1ZXN0LmZvcm0uZ2V0KCd0aXRsZScsICcnKS5zdHJpcCgpCiAgICBpZiB0aXRsZToKICAgICAgICBjb25uID0gZ2V0X2RiX2Nvbm4oKQogICAgICAgIGN1ciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICBjdXIuZXhlY3V0ZSgiSU5TRVJUIElOVE8gdGFza3MgKHRpdGxlKSBWQUxVRVMgKCVzKSIsICh0aXRsZSwpKQogICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICBjdXIuY2xvc2UoKQogICAgICAgIGNvbm4uY2xvc2UoKQoKICAgIHJldHVybiByZWRpcmVjdCh1cmxfZm9yKCdpbmRleCcpKQoKCkBhcHAucm91dGUoJy90b2dnbGUvPGludDp0YXNrX2lkPicsIG1ldGhvZHM9WydQT1NUJ10pCmRlZiB0b2dnbGVfdGFzayh0YXNrX2lkKToKICAgIGNvbm4gPSBnZXRfZGJfY29ubigpCiAgICBjdXIgPSBjb25uLmN1cnNvcigpCiAgICBjdXIuZXhlY3V0ZSgiVVBEQVRFIHRhc2tzIFNFVCBkb25lID0gTk9UIGRvbmUgV0hFUkUgaWQgPSAlcyIsICh0YXNrX2lkLCkpCiAgICBjb25uLmNvbW1pdCgpCiAgICBjdXIuY2xvc2UoKQogICAgY29ubi5jbG9zZSgpCgogICAgcmV0dXJuIHJlZGlyZWN0KHVybF9mb3IoJ2luZGV4JykpCgoKQGFwcC5yb3V0ZSgnL2RlbGV0ZS88aW50OnRhc2tfaWQ+JywgbWV0aG9kcz1bJ1BPU1QnXSkKZGVmIGRlbGV0ZV90YXNrKHRhc2tfaWQpOgogICAgY29ubiA9IGdldF9kYl9jb25uKCkKICAgIGN1ciA9IGNvbm4uY3Vyc29yKCkKICAgIGN1ci5leGVjdXRlKCJERUxFVEUgRlJPTSB0YXNrcyBXSEVSRSBpZCA9ICVzIiwgKHRhc2tfaWQsKSkKICAgIGNvbm4uY29tbWl0KCkKICAgIGN1ci5jbG9zZSgpCiAgICBjb25uLmNsb3NlKCkKCiAgICByZXR1cm4gcmVkaXJlY3QodXJsX2ZvcignaW5kZXgnKSkKCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgYXBwLnJ1bihkZWJ1Zz1UcnVlLCBob3N0PScwLjAuMC4wJykK

  - path: /tmp/app/static/style.css
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: OnJvb3R7Zm9udC1mYW1pbHk6c3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLCJIZWx2ZXRpY2EgTmV1ZSIsQXJpYWx9CmJvZHl7YmFja2dyb3VuZDojZjVmN2ZhO21hcmdpbjowO3BhZGRpbmc6MjBweH0KLmNvbnRhaW5lcnttYXgtd2lkdGg6NjQwcHg7bWFyZ2luOjAgYXV0bztiYWNrZ3JvdW5kOndoaXRlO3BhZGRpbmc6MjRweDtib3JkZXItcmFkaXVzOjhweDtib3gtc2hhZG93OjAgNnB4IDE4cHggcmdiYSgwLDAsMCwwLjA2KX0KaDF7bWFyZ2luLXRvcDowfQouYWRkLWZvcm17ZGlzcGxheTpmbGV4O2dhcDo4cHg7bWFyZ2luLWJvdHRvbToxNnB4fQouYWRkLWZvcm0gaW5wdXR7ZmxleDoxO3BhZGRpbmc6OHB4IDEwcHg7Ym9yZGVyOjFweCBzb2xpZCAjZGRkO2JvcmRlci1yYWRpdXM6NnB4fQouYWRkLWZvcm0gYnV0dG9ue3BhZGRpbmc6OHB4IDEycHg7Ym9yZGVyOm5vbmU7Ym9yZGVyLXJhZGl1czo2cHg7YmFja2dyb3VuZDojNGY0NmU1O2NvbG9yOndoaXRlfQoudGFza3N7bGlzdC1zdHlsZTpub25lO3BhZGRpbmc6MDttYXJnaW46MH0KLnRhc2t7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtnYXA6OHB4O3BhZGRpbmc6OHB4IDA7Ym9yZGVyLXRvcDoxcHggc29saWQgI2YwZjBmMH0KLnRhc2sgLmlubGluZXtkaXNwbGF5OmlubGluZTttYXJnaW46MH0KLnNtYWxse2JvcmRlcjpub25lO2JhY2tncm91bmQ6dHJhbnNwYXJlbnQ7cGFkZGluZzo2cHggOHB4O2JvcmRlci1yYWRpdXM6NnB4O2N1cnNvcjpwb2ludGVyfQouc21hbGw6aG92ZXJ7YmFja2dyb3VuZDojZjBmMGZmfQouZGFuZ2Vye2NvbG9yOiNkYzI2MjZ9Ci50aXRsZXtmbGV4OjF9Ci5kb25lIC50aXRsZXt0ZXh0LWRlY29yYXRpb246bGluZS10aHJvdWdoO2NvbG9yOiM2YjcyODB9Ci5lbXB0eXtjb2xvcjojOWNhM2FmO3BhZGRpbmc6MTJweCAwfQ==

  - path: /tmp/app/requirements.txt
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: cHN5Y29wZzItYmluYXJ5fj0yLjkuMTEKRmxhc2t+PTMuMS4y

  - path: /tmp/app/templates/index.html
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9InNsIj4KPGhlYWQ+CjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIj4KPHRpdGxlPkhpdGVyIFRv4oCRRG8gKEZsYXNrKTwvdGl0bGU+CjxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iL3N0YXRpYy9zdHlsZS5jc3MiPgo8L2hlYWQ+Cjxib2R5Pgo8ZGl2IGNsYXNzPSJjb250YWluZXIiPgo8aDE+SGl0ZXIgVG/igJFEbzwvaDE+CgoKPGZvcm0gYWN0aW9uPSIvYWRkIiBtZXRob2Q9InBvc3QiIGNsYXNzPSJhZGQtZm9ybSI+CjxpbnB1dCBuYW1lPSJ0aXRsZSIgcGxhY2Vob2xkZXI9Ik5vdmEgbmFsb2dhLi4uIiByZXF1aXJlZD4KPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPkRvZGFqPC9idXR0b24+CjwvZm9ybT4KCgo8dWwgY2xhc3M9InRhc2tzIj4KeyUgZm9yIHRhc2sgaW4gdGFza3MgJX0KPGxpIGNsYXNzPSJ0YXNrIHslIGlmIHRhc2suZG9uZSAlfWRvbmV7JSBlbmRpZiAlfSI+Cjxmb3JtIGFjdGlvbj0iL3RvZ2dsZS97eyB0YXNrLmlkIH19IiBtZXRob2Q9InBvc3QiIGNsYXNzPSJpbmxpbmUiPgo8YnV0dG9uIGNsYXNzPSJzbWFsbCIgdGl0bGU9Ik96bmHEjWkvb2R6bmFraSI+eyUgaWYgdGFzay5kb25lICV94oa6eyUgZWxzZSAlfeKck3slIGVuZGlmICV9PC9idXR0b24+CjwvZm9ybT4KCgo8c3BhbiBjbGFzcz0idGl0bGUiPnt7IHRhc2sudGl0bGUgfX08L3NwYW4+CgoKPGZvcm0gYWN0aW9uPSIvZGVsZXRlL3t7IHRhc2suaWQgfX0iIG1ldGhvZD0icG9zdCIgY2xhc3M9ImlubGluZSI+CjxidXR0b24gY2xhc3M9InNtYWxsIGRhbmdlciIgdGl0bGU9Ikl6YnJpxaFpIj7inJU8L2J1dHRvbj4KPC9mb3JtPgo8L2xpPgp7JSBlbHNlICV9CjxsaSBjbGFzcz0iZW1wdHkiPk5pIG5hbG9nIOKAlCBkb2RhaiBwcnZvITwvbGk+CnslIGVuZGZvciAlfQo8L3VsPgo8L2Rpdj4KPC9ib2R5Pgo8L2h0bWw+

  # Nginx
  - path: /run/install-nginx.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: YXBrIGFkZCBuZ2lueAoKYWRkdXNlciAtRCAtZyAnd3d3JyB3d3cKCm1rZGlyIC93d3cKY2hvd24gLVIgd3d3Ond3dyAvdmFyL2xpYi9uZ2lueApjaG93biAtUiB3d3c6d3d3IC93d3cKCnJtIC9ldGMvbmdpbngvbmdpbnguY29uZgptdiAvdG1wL25naW54LmNvbmYgL2V0Yy9uZ2lueC9uZ2lueC5jb25mCgpyYy11cGRhdGUgYWRkIG5naW54IGRlZmF1bHQKcmMtc2VydmljZSBuZ2lueCBzdGFydA==

  - path: /tmp/nginx.conf
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: dXNlciAgICAgICAgICAgICAgICAgICAgICAgICAgICB3d3c7Cndvcmtlcl9wcm9jZXNzZXMgICAgICAgICAgICAgICAgYXV0bzsgCgplcnJvcl9sb2cgICAgICAgICAgICAgICAgICAgICAgIC92YXIvbG9nL25naW54L2Vycm9yLmxvZyB3YXJuOwoKZXZlbnRzIHsKICAgIHdvcmtlcl9jb25uZWN0aW9ucyAgICAgICAgICAxMDI0Owp9CgpodHRwIHsKICAgIGluY2x1ZGUgICAgICAgICAgICAgICAgICAgICAvZXRjL25naW54L21pbWUudHlwZXM7CiAgICBkZWZhdWx0X3R5cGUgICAgICAgICAgICAgICAgYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtOwogICAgYWNjZXNzX2xvZyAgICAgICAgICAgICAgICAgIC92YXIvbG9nL25naW54L2FjY2Vzcy5sb2c7CiAgICBrZWVwYWxpdmVfdGltZW91dCAgICAgICAgICAgMzAwMDsKICAgIHNlcnZlciB7CiAgICAgICAgbGlzdGVuICAgICAgICAgICAgICAgICAgODA7CiAgICAgICAgc2VydmVyX25hbWUgCQkJYXBwLmRldm9wcy5nYXBpLm1lOwogICAgICAgIGxvY2F0aW9uIC8gewogICAgICAgICAgICBwcm94eV9wYXNzICAgICAgICAgIGh0dHA6Ly8xMjcuMC4wLjE6NTAwMDsKICAgICAgICAgICAgcHJveHlfc2V0X2hlYWRlciAgICBIb3N0ICRob3N0OwogICAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyICAgIFgtUmVhbC1JUCAkcmVtb3RlX2FkZHI7CiAgICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgICAgWC1Gb3J3YXJkZWQtRm9yICRwcm94eV9hZGRfeF9mb3J3YXJkZWRfZm9yOwogICAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyICAgIFgtRm9yd2FyZGVkLVByb3RvICRzY2hlbWU7CiAgICAgICAgfQogICAgfQoKICAgIHNlcnZlciB7CiAgICAJbGlzdGVuIDgwOwoJCXNlcnZlcl9uYW1lIGdyYWZhbmEuZGV2b3BzLmdhcGkubWU7CgkJbG9jYXRpb24gLyB7CgkJCXByb3h5X3Bhc3MgICAgICAgICAgaHR0cDovLzEyNy4wLjAuMTozMDAwOwoJCQlwcm94eV9zZXRfaGVhZGVyICAgIEhvc3QgJGhvc3Q7CgkJCXByb3h5X3NldF9oZWFkZXIgICAgWC1SZWFsLUlQICRyZW1vdGVfYWRkcjsKCQkJcHJveHlfc2V0X2hlYWRlciAgICBYLUZvcndhcmRlZC1Gb3IgJHByb3h5X2FkZF94X2ZvcndhcmRlZF9mb3I7CgkJCXByb3h5X3NldF9oZWFkZXIgICAgWC1Gb3J3YXJkZWQtUHJvdG8gJHNjaGVtZTsKCQl9CiAgICB9CgogICAgc2VydmVyIHsKICAgICAgICAJbGlzdGVuIDgwOwogICAgCQlzZXJ2ZXJfbmFtZSBhbGxveS5kZXZvcHMuZ2FwaS5tZTsKICAgIAkJbG9jYXRpb24gLyB7CiAgICAJCQlwcm94eV9wYXNzICAgICAgICAgIGh0dHA6Ly8xMjcuMC4wLjE6MTIzNDU7CiAgICAJCQlwcm94eV9zZXRfaGVhZGVyICAgIEhvc3QgJGhvc3Q7CiAgICAJCQlwcm94eV9zZXRfaGVhZGVyICAgIFgtUmVhbC1JUCAkcmVtb3RlX2FkZHI7CiAgICAJCQlwcm94eV9zZXRfaGVhZGVyICAgIFgtRm9yd2FyZGVkLUZvciAkcHJveHlfYWRkX3hfZm9yd2FyZGVkX2ZvcjsKICAgIAkJCXByb3h5X3NldF9oZWFkZXIgICAgWC1Gb3J3YXJkZWQtUHJvdG8gJHNjaGVtZTsKICAgIAkJfQogICAgICAgIH0KfQ==

  # Grafana
  - path: /run/install-grafana.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: bWFjaD0kKHVuYW1lIC1tKQoKaWYgW1sgJG1hY2ggPT0gYWFyY2g2NCBdXTsgdGhlbgogIGFyY2g9ImFybTY0IgplbGlmIFtbICRtYWNoID09IHg4Nl82NCBdXTsgdGhlbgogIGFyY2g9ImFtZDY0IgpmaQoKd2dldCAtTyAvdG1wL2dyYWZhbmEudGFyLmd6ICJodHRwczovL2RsLmdyYWZhbmEuY29tL2dyYWZhbmEvcmVsZWFzZS8xMi4yLjEvZ3JhZmFuYV8xMi4yLjFfMTg2NTU4NDk2MzRfbGludXhfJGFyY2gudGFyLmd6IgoKdGFyIC16eHZmIC90bXAvZ3JhZmFuYS50YXIuZ3ogLUMgL3RtcAoKbXYgL3RtcC9ncmFmYW5hLTEyLjIuMSAvdXNyL2xvY2FsL2dyYWZhbmEKCnJtIC1yZiAvdXNyL2xvY2FsL2dyYWZhbmEvY29uZi9wcm92aXNpb25pbmcKbXYgL3RtcC9wcm92aXNpb25pbmcgL3Vzci9sb2NhbC9ncmFmYW5hL2NvbmYKCmNhdCA8PCBFT0YgPiAvZXRjL2luaXQuZC9ncmFmYW5hCiMhL3NiaW4vb3BlbnJjLXJ1bgpuYW1lPSJncmFmYW5hIgpjb21tYW5kPSIvdXNyL2xvY2FsL2dyYWZhbmEvYmluL2dyYWZhbmEiCmNvbW1hbmRfYXJncz0ic2VydmVyIC0tY29uZmlnPS91c3IvbG9jYWwvZ3JhZmFuYS9jb25mL2RlZmF1bHRzLmluaSAtLWhvbWVwYXRoPS91c3IvbG9jYWwvZ3JhZmFuYSIKY29tbWFuZF9iYWNrZ3JvdW5kPSJ5ZXMiCnBpZGZpbGU9Ii9ydW4vZ3JhZmFuYS5waWQiCm91dHB1dF9sb2c9Ii92YXIvbG9nL2dyYWZhbmEubG9nIgplcnJvcl9sb2c9Ii92YXIvbG9nL2dyYWZhbmEuZXJyIgpFT0YKCmNobW9kICt4IC9ldGMvaW5pdC5kL2dyYWZhbmEKCnJjLXVwZGF0ZSBhZGQgZ3JhZmFuYSBkZWZhdWx0CnJjLXNlcnZpY2UgZ3JhZmFuYSBzdGFydAo=

  - path: /tmp/provisioning/dashboards/dashboard.json
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: ewogICJhbm5vdGF0aW9ucyI6IHsKICAgICJsaXN0IjogWwogICAgICB7CiAgICAgICAgImJ1aWx0SW4iOiAxLAogICAgICAgICJkYXRhc291cmNlIjogewogICAgICAgICAgInR5cGUiOiAiZ3JhZmFuYSIsCiAgICAgICAgICAidWlkIjogIi0tIEdyYWZhbmEgLS0iCiAgICAgICAgfSwKICAgICAgICAiZW5hYmxlIjogdHJ1ZSwKICAgICAgICAiaGlkZSI6IHRydWUsCiAgICAgICAgImljb25Db2xvciI6ICJyZ2JhKDAsIDIxMSwgMjU1LCAxKSIsCiAgICAgICAgIm5hbWUiOiAiQW5ub3RhdGlvbnMgJiBBbGVydHMiLAogICAgICAgICJ0eXBlIjogImRhc2hib2FyZCIKICAgICAgfQogICAgXQogIH0sCiAgImVkaXRhYmxlIjogdHJ1ZSwKICAiZmlzY2FsWWVhclN0YXJ0TW9udGgiOiAwLAogICJncmFwaFRvb2x0aXAiOiAwLAogICJpZCI6IDAsCiAgImxpbmtzIjogW10sCiAgInBhbmVscyI6IFsKICAgIHsKICAgICAgImRhdGFzb3VyY2UiOiB7CiAgICAgICAgInR5cGUiOiAibG9raSIsCiAgICAgICAgInVpZCI6ICJQOEU4MEY5QUVGMjFGNjk0MCIKICAgICAgfSwKICAgICAgImZpZWxkQ29uZmlnIjogewogICAgICAgICJkZWZhdWx0cyI6IHt9LAogICAgICAgICJvdmVycmlkZXMiOiBbXQogICAgICB9LAogICAgICAiZ3JpZFBvcyI6IHsKICAgICAgICAiaCI6IDIyLAogICAgICAgICJ3IjogMjQsCiAgICAgICAgIngiOiAwLAogICAgICAgICJ5IjogMAogICAgICB9LAogICAgICAiaWQiOiAxLAogICAgICAib3B0aW9ucyI6IHsKICAgICAgICAiZGVkdXBTdHJhdGVneSI6ICJub25lIiwKICAgICAgICAiZW5hYmxlSW5maW5pdGVTY3JvbGxpbmciOiBmYWxzZSwKICAgICAgICAiZW5hYmxlTG9nRGV0YWlscyI6IHRydWUsCiAgICAgICAgInByZXR0aWZ5TG9nTWVzc2FnZSI6IGZhbHNlLAogICAgICAgICJzaG93Q29tbW9uTGFiZWxzIjogZmFsc2UsCiAgICAgICAgInNob3dMYWJlbHMiOiBmYWxzZSwKICAgICAgICAic2hvd1RpbWUiOiBmYWxzZSwKICAgICAgICAic29ydE9yZGVyIjogIkRlc2NlbmRpbmciLAogICAgICAgICJ3cmFwTG9nTWVzc2FnZSI6IGZhbHNlCiAgICAgIH0sCiAgICAgICJwbHVnaW5WZXJzaW9uIjogIjEyLjIuMSIsCiAgICAgICJ0YXJnZXRzIjogWwogICAgICAgIHsKICAgICAgICAgICJkYXRhc291cmNlIjogewogICAgICAgICAgICAidHlwZSI6ICJsb2tpIiwKICAgICAgICAgICAgInVpZCI6ICJQOEU4MEY5QUVGMjFGNjk0MCIKICAgICAgICAgIH0sCiAgICAgICAgICAiZGlyZWN0aW9uIjogImJhY2t3YXJkIiwKICAgICAgICAgICJlZGl0b3JNb2RlIjogImJ1aWxkZXIiLAogICAgICAgICAgImV4cHIiOiAie2pvYj1cInRvZG9hcHBcIn0gfD0gYGAiLAogICAgICAgICAgInF1ZXJ5VHlwZSI6ICJyYW5nZSIsCiAgICAgICAgICAicmVmSWQiOiAiQSIKICAgICAgICB9CiAgICAgIF0sCiAgICAgICJ0aXRsZSI6ICJUT0RPIEFwcCBMb2dzIiwKICAgICAgInR5cGUiOiAibG9ncyIKICAgIH0KICBdLAogICJwcmVsb2FkIjogZmFsc2UsCiAgInNjaGVtYVZlcnNpb24iOiA0MiwKICAidGFncyI6IFtdLAogICJ0ZW1wbGF0aW5nIjogewogICAgImxpc3QiOiBbXQogIH0sCiAgInRpbWUiOiB7CiAgICAiZnJvbSI6ICJub3ctNmgiLAogICAgInRvIjogIm5vdyIKICB9LAogICJ0aW1lcGlja2VyIjoge30sCiAgInRpbWV6b25lIjogImJyb3dzZXIiLAogICJ0aXRsZSI6ICJMb2dzIiwKICAidWlkIjogImFkZHJ2enYiLAogICJ2ZXJzaW9uIjogMgp9

  - path: /tmp/provisioning/dashboards/default.yaml
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: YXBpVmVyc2lvbjogMQoKcHJvdmlkZXJzOgogIC0gbmFtZTogRGVmYXVsdAogICAgZm9sZGVyOiBMb2dzCiAgICB0eXBlOiBmaWxlCiAgICBvcHRpb25zOgogICAgICBwYXRoOiAvdXNyL2xvY2FsL2dyYWZhbmEvY29uZi9wcm92aXNpb25pbmcvZGFzaGJvYXJkcw==

  - path: /tmp/provisioning/datasources/datasources.yaml
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: YXBpVmVyc2lvbjogMQoKZGF0YXNvdXJjZXM6CiAgLSBuYW1lOiBMb2tpCiAgICB0eXBlOiBsb2tpCiAgICB1cmw6IGh0dHA6Ly9sb2NhbGhvc3Q6MzEwMA==

  # Loki
  - path: /run/install-loki.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: bWFjaD0kKHVuYW1lIC1tKQppZiBbWyAkbWFjaCA9PSBhYXJjaDY0IF1dOyB0aGVuCiAgYXJjaD0iYXJtNjQiCmVsaWYgW1sgJG1hY2ggPT0geDg2XzY0IF1dOyB0aGVuCiAgYXJjaD0iYW1kNjQiCmZpCgp3Z2V0IC1PIC90bXAvbG9raS56aXAgImh0dHBzOi8vZ2l0aHViLmNvbS9ncmFmYW5hL2xva2kvcmVsZWFzZXMvZG93bmxvYWQvdjMuNi4wL2xva2ktbGludXgtJGFyY2guemlwIgoKdW56aXAgLWQgL3RtcCAvdG1wL2xva2kuemlwCgptdiAiL3RtcC9sb2tpLWxpbnV4LSRhcmNoIiAvdXNyL2xvY2FsL2Jpbi9sb2tpCgpjaG1vZCAreCAvdXNyL2xvY2FsL2Jpbi9sb2tpCgpta2RpciAvdXNyL2xvY2FsL2xva2kKCm12IC90bXAvbG9raS1jb25maWcueWFtbCAvdXNyL2xvY2FsL2xva2kvbG9raS1jb25maWcueWFtbAoKCmNhdCA8PCBFT0YgPiAvZXRjL2luaXQuZC9sb2tpCiMhL3NiaW4vb3BlbnJjLXJ1bgpuYW1lPSJsb2tpIgpjb21tYW5kPSIvdXNyL2xvY2FsL2Jpbi9sb2tpIgpjb21tYW5kX2FyZ3M9Ii1jb25maWcuZmlsZT0vdXNyL2xvY2FsL2xva2kvbG9raS1jb25maWcueWFtbCIKY29tbWFuZF9iYWNrZ3JvdW5kPSJ5ZXMiCnBpZGZpbGU9Ii9ydW4vbG9raS5waWQiCm91dHB1dF9sb2c9Ii92YXIvbG9nL2xva2kubG9nIgplcnJvcl9sb2c9Ii92YXIvbG9nL2xva2kuZXJyIgpFT0YKCmNobW9kICt4IC9ldGMvaW5pdC5kL2xva2kKCnJjLXVwZGF0ZSBhZGQgbG9raSBkZWZhdWx0CnJjLXNlcnZpY2UgbG9raSBzdGFydA==

  - path: /tmp/loki-config.yaml
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: YXV0aF9lbmFibGVkOiBmYWxzZQoKc2VydmVyOgogIGh0dHBfbGlzdGVuX3BvcnQ6IDMxMDAKCmNvbW1vbjoKICByaW5nOgogICAgaW5zdGFuY2VfYWRkcjogMTI3LjAuMC4xCiAgICBrdnN0b3JlOgogICAgICBzdG9yZTogaW5tZW1vcnkKICByZXBsaWNhdGlvbl9mYWN0b3I6IDEKICBwYXRoX3ByZWZpeDogL3Vzci9sb2NhbC9sb2tpL2RhdGEKCnNjaGVtYV9jb25maWc6CiAgY29uZmlnczoKICAtIGZyb206IDIwMjAtMDUtMTUKICAgIHN0b3JlOiB0c2RiCiAgICBvYmplY3Rfc3RvcmU6IGZpbGVzeXN0ZW0KICAgIHNjaGVtYTogdjEzCiAgICBpbmRleDoKICAgICAgcHJlZml4OiBpbmRleF8KICAgICAgcGVyaW9kOiAyNGgKCnN0b3JhZ2VfY29uZmlnOgogIGZpbGVzeXN0ZW06CiAgICBkaXJlY3Rvcnk6IC91c3IvbG9jYWwvbG9raS9kYXRhL2NodW5rcw==

  # Alloy
  - path: /run/install-alloy.sh
    owner: root:root
    permissions: "0755"
    encoding: b64
    content: bWFjaD0kKHVuYW1lIC1tKQoKaWYgW1sgJG1hY2ggPT0gYWFyY2g2NCBdXTsgdGhlbgogIGFyY2g9ImFybTY0IgplbGlmIFtbICRtYWNoID09IHg4Nl82NCBdXTsgdGhlbgogIGFyY2g9ImFtZDY0IgpmaQoKYXBrIGFkZCBnY29tcGF0Cgp3Z2V0IC1PIC90bXAvYWxsb3kuemlwICJodHRwczovL2dpdGh1Yi5jb20vZ3JhZmFuYS9hbGxveS9yZWxlYXNlcy9kb3dubG9hZC92MS4xMS4zL2FsbG95LWxpbnV4LSRhcmNoLnppcCIKCnVuemlwIC1kIC90bXAgL3RtcC9hbGxveS56aXAKCm12ICIvdG1wL2FsbG95LWxpbnV4LSRhcmNoIiAvdXNyL2xvY2FsL2Jpbi9hbGxveQoKY2htb2QgK3ggL3Vzci9sb2NhbC9iaW4vYWxsb3kKCm1rZGlyIC1wICIvdmFyL2xpYi9hbGxveS9kYXRhIgpta2RpciAtcCAiL2V0Yy9hbGxveSIKCm12IC90bXAvY29uZmlnLmFsbG95IC9ldGMvYWxsb3kvY29uZmlnLmFsbG95CgpjYXQgPDwgRU9GID4gL2V0Yy9pbml0LmQvYWxsb3kKIyEvc2Jpbi9vcGVucmMtcnVuCm5hbWU9ImFsbG95Igpjb21tYW5kPSIvdXNyL2xvY2FsL2Jpbi9hbGxveSIKY29tbWFuZF9hcmdzPSJydW4gL2V0Yy9hbGxveS9jb25maWcuYWxsb3kgLS1zdG9yYWdlLnBhdGg9L3Zhci9saWIvYWxsb3kvZGF0YSAtLXNlcnZlci5odHRwLmxpc3Rlbi1hZGRyPTAuMC4wLjA6MTIzNDUiCmNvbW1hbmRfYmFja2dyb3VuZD0ieWVzIgpwaWRmaWxlPSIvcnVuL2FsbG95LnBpZCIKb3V0cHV0X2xvZz0iL3Zhci9sb2cvYWxsb3kubG9nIgplcnJvcl9sb2c9Ii92YXIvbG9nL2FsbG95LmVyciIKRU9GCgpjaG1vZCAreCAvZXRjL2luaXQuZC9hbGxveQoKcmMtdXBkYXRlIGFkZCBhbGxveSBkZWZhdWx0CnJjLXNlcnZpY2UgYWxsb3kgc3RhcnQ=

  - path: /tmp/config.alloy
    owner: root:root
    permissions: "0644"
    encoding: b64
    content: bGl2ZWRlYnVnZ2luZyB7CiAgZW5hYmxlZCA9IHRydWUKfQoKbG9jYWwuZmlsZV9tYXRjaCAibG9jYWxfZmlsZXMiIHsKICAgIHBhdGhfdGFyZ2V0cyA9IFt7Il9fcGF0aF9fIiA9ICIvdmFyL2xvZy90b2RvYXBwLmVyciIsICJqb2IiID0gInRvZG9hcHAiLCAiaG9zdG5hbWUiID0gY29uc3RhbnRzLmhvc3RuYW1lfV0KICAgIHN5bmNfcGVyaW9kICA9ICI1cyIKfQoKbG9raS5zb3VyY2UuZmlsZSAibG9nX3NjcmFwZSIgewogICAgdGFyZ2V0cyAgICA9IGxvY2FsLmZpbGVfbWF0Y2gubG9jYWxfZmlsZXMudGFyZ2V0cwogICAgZm9yd2FyZF90byA9IFtsb2tpLndyaXRlLmxvY2FsLnJlY2VpdmVyXQogICAgdGFpbF9mcm9tX2VuZCA9IHRydWUKfQoKbG9raS53cml0ZSAibG9jYWwiIHsKICBlbmRwb2ludCB7CiAgICB1cmwgPSAiaHR0cDovL2xvY2FsaG9zdDozMTAwL2xva2kvYXBpL3YxL3B1c2giCiAgfQp9

runcmd:
  - setup-dns 1.1.1.1
  - /run/install-postgres.sh
  - /run/install-app.sh
  - /run/install-nginx.sh
  - /run/install-grafana.sh
  - /run/install-loki.sh
  - /run/install-alloy.sh
